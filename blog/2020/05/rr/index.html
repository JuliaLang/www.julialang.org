<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta http-equiv=content-type  content="text/html; charset=utf-8" /> <meta name=author  content="Jeff Bezanson, Stefan Karpinski, Viral Shah, Alan Edelman, et al." /> <meta name=description  content="The official website for the Julia Language. Julia is a language that is fast, dynamic, easy to use, and open source. Click here to learn more."/> <meta property="og:title" content="The Julia Language"/> <meta property="og:image" content="/assets/images/julia-open-graph.png"/> <meta property="og:description" content="Official website for the Julia programming language"/> <link rel=stylesheet  href="/libs/bootstrap/bootstrap.min.css" /> <link rel=stylesheet  href="/css/app.css" /> <link rel=stylesheet  href="/css/franklin.css" /> <link rel=stylesheet  href="/css/fonts.css" /> <link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500,500i,700,700i" rel=stylesheet > <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel=stylesheet > <script async defer src="/libs/buttons.js"></script> <!-- --> <script type="application/javascript"> var doNotTrack = false; if (!doNotTrack) { window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; ga('create', 'UA-28835595-1', 'auto'); ga('send', 'pageview'); } </script> <script async src='https://www.google-analytics.com/analytics.js'></script> <link rel=icon  href="/assets/infra/julia.ico"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <title>Julia 1.5 Feature Preview: Time Traveling (Linux) Bug Reporting</title> <style> .container ul li p {margin-bottom: 0;} </style> <style> .main { font-family: Georgia; } .main pre { margin-left: auto; margin-right: auto; } .main { width: 100%; font-size: 100%; } .main code { font-size: 90%; } .main pre code { font-size: 90%; } @media (min-width: 940px) { .main { width: 800px; } .container.blog-title { width: 800px;} } </style> <meta property="og:video" content="https://julialang.org/assets/blog/2020-05-02-rr/preview.mp4" ><meta name="twitter:player" content="https://www.youtube.com/embed/JO6Jvad3XRU" ><meta name="twitter:player:width" content=960  ><meta name="twitter:player:height" content=720  > <div class="container py-3 py-lg-0"> <nav class="navbar navbar-expand-lg navbar-light bg-light" id=main-menu > <a class=navbar-brand  href="/"> <img src="/assets/infra/logo.svg" alt="JuliaLang Logo"> </a> <button class="navbar-toggler ml-auto hidden-sm-up float-xs-left" type=button  data-toggle=collapse  data-target="#navbarSupportedContent" aria-controls=navbarSupportedContent  aria-expanded=false  aria-label="Toggle navigation"> <span class=navbar-toggler-icon ></span> </button> <div class="collapse navbar-collapse" id=navbarSupportedContent > <ul class="navbar-nav mx-auto"> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/downloads/">Download</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="https://docs.julialang.org">Documentation</a> <li class="nav-item active flex-md-fill text-md-center"> <a class=nav-link  href="/blog/">Blog</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/community/">Community</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/learning/">Learn</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/research/">Research</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/jsoc/">JSoC</a> </ul> <span class=navbar-right > <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </span> </div> </nav> </div> <br><br> <div class="container blog-title"> <h1>Julia 1.5 Feature Preview: Time Traveling (Linux) Bug Reporting <a type="application/rss+xml" href="https://julialang.org/feed.xml"> <i class="fa fa-rss-square rss-icon"></i> </a> </h1> <h3> <span style="font-weight: lighter;"> 2 May 2020 </span> | <span style="font-weight: bold;"></span> <span style="font-weight: bold;">Keno Fischer </span> </h3> </div> <a href="https://github.com/JuliaLang/www.julialang.org/blob/master/blog/2020/05/rr.md" title="Edit this page on GitHub" class=edit-float > </a> <div class="container main"> <link rel=stylesheet  type="text/css" href="/assets/blog/2020-05-02-rr/asciinema-player.css" /> <script src="/assets/blog/2020-05-02-rr/asciinema-player.js"></script> <style> @keyframes journey { from { transform: scale(1) } 10% { transform: translate(-5%,-14%) scale(0.1) rotateZ(30deg); } 20% { transform: translate(-10%,-25%) scale(0.1) rotateZ(30deg); } 30% { transform: translate(-5%,-30%) scale(0.1) rotateZ(30deg); } 40% { transform: translate(-5%,-30%) scale(0.05) rotateZ(30deg); } 55% { transform: translate(-5%,-30%) scale(0.05) rotateZ(30deg); } 60% { transform: translate(-5%,-35%) scale(0.05) rotateZ(30deg); } 90% { transform: translate(8%,-25%) scale(0.1) rotateZ(30deg) rotateX(140deg); } } @keyframes fadeIn { 10% { opacity:1; } 90% { opacity:1; } } #player_main { position: absolute; left: 0; right: 0; margin: auto; z-index: 1; } #after_animation { margin-top: 700px; } #player_main.animated { animation-name: journey; animation-delay: 2s; animation-duration: 10s; } #arch_diagram { position: absolute; left: 0; right: 0; margin: auto; z-index: 0; opacity: 0; width: 629px; height: 282px; } #arch_diagram.animated { animation-name: fadeIn; animation-delay: 2s; animation-duration: 10s; } .hidden { display: none; } .control-bar { display: none; } #animation { height: 700px; } .container li > p { margin-bottom: 0 } </style> <div id=animation > <div id=player_main > <asciinema-player author="Keno Fischer" cols=100  id=record_player  rows=40  speed=2  theme=asciinema  title=Recording  src="/assets/blog/2020-05-02-rr/record.cast"> </asciinema-player> <asciinema-player author="Keno Fischer" cols=100  id=replay_player  class=hidden  rows=40  speed=1.5  theme=asciinema  title=Recording  src="/assets/blog/2020-05-02-rr/replay.cast"> </asciinema-player> </div> <image id=arch_diagram  src="/assets/blog/2020-05-02-rr/arch.svg"/> </div> <script> document.getElementById('record_player').addEventListener('ended', function(e) { document.getElementById('player_main').classList.add("animated"); document.getElementById('arch_diagram').classList.add("animated"); document.getElementById('player_main').addEventListener('animationend', () => { document.getElementById('record_player').classList.add("hidden"); document.getElementById('replay_player').classList.remove("hidden"); document.getElementById('replay_player').play(); }); }); </script> <p>The Julia project, like any large open source project, gets a large number of bug reports every day. As the developers of the language, we try our best to be as responsive as possible and to triage, investigate and fix any bugs as quickly as possible. For some bugs, this is easy. If the bug report is well written and the problem is evident, getting it fixed is usually a quick affair. However, for a large number of reports, this is not as easy. There are several common reasons why bugs may go unaddressed for extended periods of time, for example:</p> <ol> <li><p>The bug may not reproduce deterministically, or may only reproduce on the reporter&#39;s machine &#40;sometimes known as a <a href="https://en.wikipedia.org/wiki/Heisenbug">Heisenbug</a>&#41;.</p> <li><p>The bug report may be incomplete in specifying the environment in which the bug occurs, making it hard to reproduce.</p> <li><p>The bug reporter may have seen the bug once, but not been entirely sure what caused it making it hard to give a reproducer and making the bug report largely unactionable.</p> <li><p>The bug may occur only in a large project that is hard to set up.</p> <li><p>The bug may require specialized expertise to diagnose &#40;e.g. a missing GC root&#41;. Usually, the time of such experts is in high demand, making the time commitment required to reproduce and investigate such bugs prohibitive.</p> </ol> <p>In addition, there are the bugs that never get filed, because the user may feel the effort to write a high-quality bug report is too high. Such experiences are frustrating both for the users encountering them and for us. We often don&#39;t learn about these experiences and sometimes only hear about them years later. Somebody may have given up on their project in Julia because they encountered some crashing problem that they didn&#39;t feel qualified to reduce into a concise bug report and subsequently gave up on using Julia for their project. Lastly, we don&#39;t want or expect our users to be expert bug reporters. They are often working scientists who are good programmers, but may not have any background in software engineering. These are some of our most valuable users, and we want to make sure their bugs are addressed.</p> <p>In the past, for users who did encounter particularly difficult problems, we have for a long time had one answer: If you can reproduce it on a linux machine and get us a trace from the <code>rr</code> tool <a href="https://rr-project.org/">https://rr-project.org/</a>, we can probably get it fixed for you very rapidly. For the uninitiated, <code>rr</code> is a Linux debugging tool originally developed at Mozilla by Robert O&#39;Callahan and others. It is a tool known as a &quot;time traveling debugger&quot; or &quot;reverse execution engine&quot;. Essentially, <code>rr</code> splits reproducing bugs into two phases: &quot;record&quot; and a &quot;replay&quot;. The record phase is performed by the bug reporter. During this phase, <code>rr</code> creates a perfect record of the execution, including the <em>bitwise exact</em> memory and register state after every instruction. This trace can then be analyzed during the replay phase &#40;which can be performed by a different developer on a different machine&#41;. Capabilities like these have long been imagined in academia, but are extremely hard to achieve in a way that does not introduce large overheads or distort regular execution. <code>rr</code> is the first such tool that &#40;in our experience&#41; is performant enough to be used in the regular course of development. It is worth discussing how this is achieved &#40;and what limitations the approach has&#41;, but first let&#39;s take the capabilities for granted and take a look at the workflow it enables.</p> <p>In Julia 1.5, which will be released in a few weeks, there is now a new command line flag <code>--bug-report&#61;rr</code> that will automatically create and upload an <code>rr</code> recording. An example usage is shown in the animation at the start of this post &#40;which just creates a deliberate crash by unsafely dereferencing a bad pointer&#41;. However to summarize:</p> <ol> <li><p>The bug reporter passes <code>--bug-report&#61;rr</code> to her julia instance and reproduces whatever bug she is attempting to reproduce.</p> <li><p>Once julia exits or crashes, the bug reporter is prompted to authorize an upload by clicking on a link &#40;GitHub-based authentication is used for abuse protection&#41;. She then gets back a link to include when filing a bug report against julia or some other package.</p> <li><p>Any developer can use the link to obtain the recording and analyze it on their own machine.</p> </ol> <p>In addition to this manual mechanism, we are also switching our linux CI systems to automatically create <code>rr</code> traces of any execution. This way, if a CI run fails, we are guaranteed to be able to debug it.</p> <p>If a bug report includes a link to an <code>rr</code> trace, in theory no further reproduction instructions are required. The <code>rr</code> trace is guaranteed to perfectly capture the environment the bug was reproduced in. Of course, if the bug is something non-obvious like unexpected behavior, some comments on what the expected behavior was may still be helpful. Having perfect reproducability almost immediately knocks out all the common problems I started this post with. &quot;Works for me&quot; is no longer an available answer. If it&#39;s in the trace, it broke on somebody&#39;s machine and can be debugged. &quot;Heisenbug&quot;s are no longer an issue. If it was captured once in <code>rr</code>, it can always be debugged. It even solves the busy-expert problem, as it allows non-experts to help out with triage. If such a report does not contain an <code>rr</code> trace, any developer, and in particular non-experts, can attempt to reproduce the bug and create a trace. Even if the expert is still required to do the final diagnosis, doing so from an <code>rr</code> trace is orders of magnitude faster than from a plain bug report.</p> <h1 id=chronomancy_for_dummies ><a href="#chronomancy_for_dummies">Chronomancy for dummies</a></h1> <p>A computer is fundamentally a deterministic machine. Given equivalent states as inputs, most instructions will produce a deterministic state as output. So where do all the subtle execution differences come from that produce diverging executions and prevent bugs from reproducing? Well, the complete answer is complicated and has lots of details, but is roughly split up into:</p> <ol> <li><p>The size of the input state. Naively this state encompasses at least your entire hard drive and memory. That&#39;s at least <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><msup><mn>2</mn><mtext>large</mtext></msup></msup></mrow><annotation encoding="application/x-tex">2^{2^\text{large}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.01192em;vertical-align:0em;"></span><span class=mord ><span class=mord >2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:1.01192em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9270285714285713em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord text mtight"><span class="mord mtight">large</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> bits of state right there each of which could potentially cause a difference in execution. You really want to figure out what state is relevant, since <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><msup><mn>2</mn><mtext>large</mtext></msup></msup></mrow><annotation encoding="application/x-tex">2^{2^\text{large}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.01192em;vertical-align:0em;"></span><span class=mord ><span class=mord >2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:1.01192em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9270285714285713em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord text mtight"><span class="mord mtight">large</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> is probably too many bits to send somebody.</p> <li><p>Any input or other asynchronous events. This can mean user input, or data from the network &#40;via the NICs&#41; or other devices. It also means things like the timing of interrupts.</p> <li><p>Execution ordering and data races in multi-threaded executions.</p> <li><p>Direct observation of non-determinstic hardware effects &#40;i.e. the &quot;most&quot; qualifier above&#41;. This includes instructions that are deliberately non-deterministic, such as RDRAND, which generates a random number. It also includes observable, but undesirable effects of hardware state &#40;e.g. timing side channels from cache or branch predictor state&#41;.</p> </ol> <p>However, in theory, if a tool was able to capture 100&#37; of the relevant state from these categories, it could repeatedly generate exactly the same memory image. This is not a novel idea, but the devil is in the detail. Discussing these details is beyond the scope of this particular post, but here is a taste: For an asynchonous event, how do we define &quot;when&quot; this event happened with respect to the rest of the execution. I.e. what is the correct notion of time? Real time doesn&#39;t work because instruction issue frequency isn&#39;t constant &#40;in addition to all the usual issues of dealing with time&#41;. Probably the most convenient thing to use would be the number of retired instructions, but there are some challenges here depending on the hardware &#40;which will be discussed a bit in the hardware section below&#41;.</p> <p>To summarize, for some input state <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mi mathvariant=script >i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S_{i}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.075em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, the output state <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mrow><mi mathvariant=script >i</mi><mo>+</mo><mn mathvariant=script >1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{S_{i+1}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.891661em;vertical-align:-0.208331em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.075em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mathcal mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></span> is determined by some pure, deterministic function <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >I</mi><mrow><mi>i</mi><mi>p</mi><mo stretchy=false >(</mo><msub><mi mathvariant=script >S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{I}_{ip(\mathcal{S}_i)}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.03853em;vertical-align:-0.3551999999999999em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.07382em;">I</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span>, corresponding to the instruction to be executed at time <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>, or some asynchronous event <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{A}_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal">A</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mrow><mo fence=true >{</mo><mtable rowspacing=0.3599999999999999em  columnalign="left left" columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><msub><mi mathvariant=script >A</mi><mi>i</mi></msub><mo stretchy=false >(</mo><msub><mi>S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mtext>if an asynchronous event occured at time </mtext><mstyle scriptlevel=0  displaystyle=false ><mi>i</mi></mstyle></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><msub><mi mathvariant=script >I</mi><mrow><mtext>ip</mtext><mo stretchy=false >(</mo><msub><mi mathvariant=script >S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex"> \mathcal{S}_{i+1} = \begin{cases} \mathcal{A}_i(S_{i}) &amp; \text{if an asynchronous event occured at time $i$} \\ \mathcal{I}_{\text{ip}(\mathcal{S}_i)} &amp; \text{otherwise} \end{cases} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.891661em;vertical-align:-0.208331em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class=mord ><span class=mtable ><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.69em;"><span style="top:-3.69em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord mathcal">A</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-2.25em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.07382em;">I</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ip</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.19em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:1em;"></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.69em;"><span style="top:-3.69em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class="mord text"><span class=mord >if an asynchronous event occured at time </span><span class="mord mathdefault">i</span></span></span></span><span style="top:-2.25em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class="mord text"><span class=mord >otherwise</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>Did that help? No? oh. Well, it made me feel better about my physics degree and also I&#39;ve been told it&#39;s not research until it has at least one equation in it, so there you go. Also, people worked really hard to get the equation rendering working, on this blog, so I better use it. Anyway, where were we?</p> <p>Ah yes - how does <code>rr</code> do what it does? One of the key tricks it uses is to re-use an abstraction boundary that already exists: That between the application and the underlying operating system &#40;or more specifically the Linux kernel&#41;. Exploiting this abstraction boundary as a determinism boundary &#40;that is relying on determinism to apply any changes made internal to the application, but explicitly recording any changes made by the kernel&#41; has a lot of advantages. For one, the kernel isolates a lot of state. If a part of the disk state &#40;e.g. a file&#41; wasn&#39;t requested through the kernel, you can be guaranteed that it didn&#39;t affect the process state &#40;assuming the kernel works correctly of course&#41;. It abstracts over hardware details and provides a uniform interface to resources like the network. It also isolates processes from another, so if there is one process of interest &#40;e.g. julia&#41; only the activity relevant to it has to be recovered.</p> <p>That said, this scheme also introduces some complications. In order to function, <code>rr</code> must have an extremely precise model of the operation of the kernel and the ways in which it interacts with userspace. The Linux developers work hard to attempt to keep this interface stable, but few applications put as stringent a constraint on that promise as <code>rr</code> does. Sometimes even a single bit difference in kernel behavior can be problematic&#33;</p> <p>If these details interest you, I recommend reading Robert&#39;s <a href="https://arxiv.org/abs/1610.02144">technical report</a> for a deeper overview of some of <code>rr</code>&#39;s design points &#40;though even that only scratches the surface&#41;.</p> <p>One final thought for this section is the origin of the term &quot;time-traveling&quot; debugger. It stems from the mode of analysis that a system like this enables. In a traditional debugger, it is possible to execute one instruction at a time, and step from memory state to memory state in the forwards direction. Systems like <code>rr</code> allow the opposite during replay: step backwards through the state of the system. Under the hood this is accomplished by playing forward from the beginning &#40;or more likely some intermediate checkpoint created for performance reasons&#41;, until the previous state is reached. However, to the end user, the illusion of going backwards in time is presented and an extremely useful mental model for debugging.</p> <h1 id=performance_considerations ><a href="#performance_considerations">Performance considerations</a></h1> <p>While the previous section described the operating principle of <code>rr</code>, it does not do justice to the reason why <code>rr</code> works so well. That reason is simple: performance. Overhead for recording of single threaded processes is generally below 2x, most often between 2&#37; and 50&#37; &#40;lower for purely numerical calculations, higher for workloads that interact with the OS&#41;. Recording multiple threads or processes that share memory &#40;as opposed to using kernel-based message passing&#41; is harder. By default <code>rr</code> serializes &#40;i.e. runs one after the other rather than in parallel&#41; execution of such tasks. In general, this is required for correctness, since it is not possible to observe and record the interleaving of memory operations to shared memory spaces. As a result, shared-memory applications will likely incur overhead linear in the number of concurrent threads. It is thus a good idea to try and reproduce any issues at low core count. There is some interesting academic thinking on high efficiency, parallel recording of shared memory applications, but nothing even close to being production ready.</p> <p>With that caveat in mind, here are some real benchmark numbers of overhead for the julia test suite &#40;as seen on CI&#41;. The test suite mostly uses message-passing based parallelism for running multiple tests in parallel. Only the <code>threads</code> test incurs the shared memory overhead penalty. Below, we plot the overhead of recording for each test in the julia test suite. Over the entire test suite, the mean overhead was 50&#37; &#40;i.e. on average a recorded test took 50&#37; longer than a non- recorded test, say 3s rather than 2s&#41;. As expected, the <code>threads</code> test is the worst offender with about 600&#37; overhead. However, a lot of the computational benchmarks &#40;e.g. in LinearAlgebra or SparseArrays&#41; show very little overhead. This is expected, because these tests spend a lot of time in user space, which does not require any data to be recorded.</p> <p><img src="/assets/blog/2020-05-02-rr/data/overhead.svg" alt=overhead  /></p> <p>You might wonder why some tests ran faster under rr. I have not investigated this in detail, but I believe it to be a measurement artifact. The runtime of tests can depend on what code previously ran on the same worker &#40;since common code results are chached&#41; and since work is assigned greedly to workers, a change in the schedule can sometimes result in tests running on a worker that has already cached some of the work that would have otherwise been necessary to run the test. Additionally, and fortunately for us, while the mean slow down is 50&#37; on a test-by-test basis, the overall runtime of the test suite is dominated by the low-overhead purely computations tests, plus a separate run of the <code>threads</code> test. As a result the increase in total time from running the test suite under rr is attributable almost entirely to the <code>threads</code> test alone. Surprisingly too, the traces may often be quite small&#33; The total compressed size of a trace for a full run of the test suite &#40;about 30 minutes on 10 cores&#41; is about three gigabytes. As a point of comparison this is significantly smaller than a even full-memory coredump would be at the end of the test suite run &#40;around 10GB or so, though probably decently well compressible with standard techniques&#41;. From the trace, we can not only reproduce such a core-dump, but every single of the trillions of intermediate states&#33;</p> <h1 id=hardware_and_software_limitations ><a href="#hardware_and_software_limitations">Hardware and Software limitations</a></h1> <p>As was already mentioned, <code>rr</code> currently only works on Linux. However, there are more restrictions. At the moment only x86 chips with Intel microarchitecture are supported. <code>rr</code> relies on hardware performance counters to establish a precise and accurate notion of time for asynchronous events. If these hardware counters are not available or not precise enough, recording using <code>rr</code> will not work. We and others have investigated whether it would be possible to port rr to other architectures. To the best of my knowledge, the current thinking on this is as follows:</p> <ul> <li><p>For x86_64 with AMD Ryzen microarchitecture, it seems potentially possible, but the AMD performance counters are less accurate than those found on Intel chips. It may be possible to compensate for this in software, but the inaccuracies are ill-understood. Help in investigation is welcome &#40;<a href="https://github.com/mozilla/rr/issues/2034">issue</a>&#41;.</p> <li><p>For AArch64, ll/sc-based atomics introduce additional problems, since various external factors &#40;interrupts, descheduling, etc.&#41; can be observed as sc aborts. With proper hardware support, this would be possible to work around, but such hardware support appeared to be inaccurate on older generation AArch64 chips and has been removed on recent generation ones. That said, AArch64 microarchitectures are varied and as evidenced by the x86_64 experience, the the quality of implementation of the relevant hardware support can vary quite a bit by microarchitecture. Investigation of the hardware capabilities of various AArch64 microarchitectures would be very welcome &#40;<a href="https://github.com/mozilla/rr/issues/1373">issue</a>&#41;.</p> <li><p>We have looked into <code>rr</code> on POWER9, which is found in several large supercomputers that run julia jobs. POWER9 has similar issues to AArch64 since it is also an ll/sc architecture, as well as supporting hardware transactional memory. In theory, we believe the hardware exists to compensate for these issues, but preliminary investigation suggests the hardware is not accurate enough to support <code>rr</code>. That said, I understand there&#39;s active discussions with IBM to determine whether this analysis is correct.</p> </ul> <p>One additional point of complication, in our experience, is that it is quite common for hypervisors &#40;such as those used by cloud vendors&#41; to disable the CPU capabilities required by <code>rr</code>, rendering it incapable of functioning inside virtual machines. <code>rr</code> appears works fine on the latest generation of Amazon AWS machines &#40;above a certain size&#41;, but not on Google GCP or Microsoft Azure.</p> <p>Lastly, we shouldn&#39;t fail to mention GPUs. GPUs are heavily utilized by Julia users, but are currently not supported by <code>rr</code>. Changing this is tricky. GPUs often allow direct memory access between the device and the userspace program being recorded. If the interface to the GPU is known, this can definitely be mitigated, potentially at some performance cost, e.g. by double buffering. For GPUs with open source drivers, e.g. AMDGPU, there is active community interest in building such a solution. It is not an easy task, but I think it has a decent chance of succeeding, since open source drivers allow insight into exactly how the GPU works and when it will modify process memory. GPUs with proprietary drivers are a lot harder. For one, their interface to userspace is not necessarily known. Additionally, proprietary drivers tend to be a lot less well behaved than open source ones &#40;the Linux kernel review process tends to filter out the most egregious behavior&#41;. For example, proprietary drivers have been observed to use the userspace stack for scratch space. For those GPUs in use by a large number of Julia users, we hope to work with the relevant vendors to bring this capability to their platforms, but it may be a long road.</p> <p>In summary, these new capabilities are currently only supported on Intel x86_64 chips. However, this is a bit of a chicken-and-egg problem. The hardware requirements are non-trivial, but not egregious. If the hardware vendors cared about this problem, they could definitely build hardware that enabled <code>rr</code> to work &#40;and if they really cared, they could build hardware assist features to make <code>rr</code> much faster&#41;, but without a significant user base of such features they have little incentive to care. I&#39;m hoping that by rolling out these capabilities widely, these incentives will start presenting themselves. Judging from the size of the community and discounting for those that use unsupported hardware or operating system, the number of users for whom this feature will be available likely numbers in the hundreds of thousands. That isn&#39;t super large by hardware vendor standards, but it isn&#39;t trivially small either. If any hardware vendor is interested in making this work, we&#39;d be happy to talk to you &#40;and as I mentioned, some of this is already in progress&#41;.</p> <h1 id=a_word_on_privacy ><a href="#a_word_on_privacy">A word on privacy</a></h1> <p>By its nature, an <code>rr</code> trace will contain any file touched by the process during its lifetime. In particular, this may contain things like your julia history, your process environment &#40;including any secrets you may be automatically adding to it from bashrc or similar&#41;, any configuration files for your system, any secrets entered or read &#40;i.e. make sure to use ssh-agent if your reproducer involves using SSH for authentication&#41;, any private code you may be using, etc. We are investigating building tooling to help understand what&#39;s in the trace and anonymize parts of the trace that are potentially sensitive, but do not otherwise affect the trace. For the moment, we disable reading the histry by default when creating an rr trace &#40;using the history can be explicitly opted into when necessary for reproduction&#41;. Nevertheless, please make sure to have the system administrator&#39;s permission before using the <code>--bug-report</code> feature. If you are not sure, we recommend creating the reproducer in a sanitized, isolated environment &#40;e.g. a docker container&#41;. Alternatively, while the <code>--bug-report</code> option creates a public upload by default, if you are user that has access to professional Julia support &#40;e.g. through your employer, supercomputing center or similar&#41;, you may be able to request a mechanism to share traces generated through this feature privately.</p> <h1 id=future_outlook ><a href="#future_outlook">Future outlook</a></h1> <p>Being able to replay the traces is only the beginning. I like to say that with <code>rr</code>, debugging becomes a data analysis problem, since the answer to any question you could possibly ask about the program is already contained in the trace, it just becomes a question of extracting the answer. By default, <code>rr</code> drops you into GDB, but GDB is unlikely to be the correct frontend for such analysis. <code>rr</code>&#39;s original author Robert O&#39;Callahan now has a startup working on a next-generation frontend over at <a href="https://pernos.co/">https://pernos.co/</a> &#40;no affiliation, but his work made much of this possible, so a plug is the least I can do here&#41;. That said, Julia itself tends to be a pretty good tool for data analysis and I have some ideas what such a frontend may look like &#40;notebook style, with the ability to generate plots over the 2d time x space state of the recording&#41;. There&#39;s lots of cool things that can be done. To name just a few: Checking assertions after the fact, validating GC rooting accuracy after the fact, performance analysis, super precise coverage testing, etc. In fact, having the recording enables some analysis techniques that would be prohibitively expensive to do in real time, but that is a topic for another time.</p> <h2 id=conflict_of_interest_disclaimer_funding_acknowledgement ><a href="#conflict_of_interest_disclaimer_funding_acknowledgement">Conflict of Interest disclaimer / Funding Acknowledgement</a></h2> <p>Essentially all of the companies mentioned in this blog post have in the past provided financial or other support to the Julia project. In particular, Intel and IBM have in the past supported the Julia project financially to improve support for their respective architectures. Amazon, Google and Microsoft have provided cloud computing credits as well. Intel, Google, and Microsoft have also previously sponsored JuliaCon.</p> <p>This work was primarily funded by my employer, Julia Computing. Part of Julia Computing&#39;s open source work is funded by external grants. As such, part of this work was funded under a grant from the Moore Foundation, which is gratefully acknowledged.</p> <p>Part of this work was funded under a contract from Intel to improve the stability of multi-threading in Julia on Intel platforms. Additionally, where hardware bugs were encountered during this work, they were reported to the relevant vendor under existing funded contracts.</p> <p>Further, Julia Computing has <a href="https://juliacomputing.com/blog/2019/02/13/JuliaTeam-Vision.html">previously announced</a> that <code>rr</code> integration will likely be available in future commercial offerings. This is a separate piece of work and not a Julia Computing product. If you are interested in using these capabilities with a Julia Computing product, or under your Julia Computing support agreement, please contact your support representative.</p> <p>Lastly, your author discloses his self-interest. He spends too much time trying to get bug reports to reproduce under <code>rr</code> so they can be fixed, so if y&#39;all would do that for me, that&#39;d be swell.</div><br><br> <footer class="container-fluid footer-copy"> <div class=container > <div class="row footrow"> <ul> <li><a href="/project">About</a> <li><a href="/about/help">Get Help</a> <li><a href="/community/#julia_github_groups">Domains</a> <li><a href="/blog/2019/02/julia-entities/">Governance</a> <li><a href="/research/#publications">Publications</a> <li><a href="/research/#sponsors">Sponsors</a> </ul> <ul> <li><a href="/downloads/">Downloads</a> <li><a href="/downloads/">All Releases</a> <li><a href="https://github.com/JuliaLang/julia">Source Code</a> <li><a href="/downloads/#current_stable_release">Current Stable Release</a> <li><a href="/downloads/#long_term_support_release">Longterm Support Release</a> <li><a href="/downloads/platform/#platform_specific_instructions_for_unofficial_binaries">Unofficial Binaries</a> </ul> <ul> <li><a href="https://docs.julialang.org/en/v1/">Documentation</a> <li><a href="https://www.youtube.com/user/JuliaLanguage">Video Talks</a> <li><a href="/learning/getting-started/">Beginners Guide</a> <li><a href="https://docs.julialang.org/en/v1/manual/faq/">FAQ</a> <li><a href="/learning/#books">Julia Books</a> </ul> <ul> <li><a href="/community/">Community</a> <li><a href="/community/#2019_julia_user_and_developer_survey">User/Developer Survey</a> <li><a href="/diversity/">Diversity</a> <li><a href="/community/#official_channels">Official Channels</a> <li><a href="/community/standards/">Code of Conduct</a> <li><a href="/community/#events">Events</a> <li><a href="https://shop.spreadshirt.com/numfocus/official+julia+logo?idea=5bca3ad9f93764414a5de55f">Shop Merchandise</a> </ul> <ul> <li><a href="https://github.com/JuliaLang/julia/blob/master/CONTRIBUTING.md">Contributing</a> <li><a href="https://github.com/JuliaLang/julia/issues">Issue Tracker</a> <li><a href="https://github.com/JuliaLang/julia/security/policy">Report a Security Issue</a> <li><a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22help+wanted%22">Help Wanted Issues</a> <li><a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22good+first+issue%22+">Good First Issue</a> <li><a href="https://docs.julialang.org/en/v1/devdocs/reflection/">Dev Docs</a> </ul> </div> <div id=footer-bottom  class=row > <div class="col-md-10 py-2"> <p>Website built with <a href="https://franklinjl.org">Franklin.jl</a> - a native Julia package for building websites. We thank <a href="https://www.fastly.com">Fastly</a> for their generous infrastructure support.</p> <p>©2020 JuliaLang.org <a href="https://github.com/JuliaLang/www.julialang.org/graphs/contributors">contributors</a>. The content on this website is made available under the <a href="https://github.com/JuliaLang/www.julialang.org/blob/master/LICENSE.md">MIT license</a>. </div> <div class="col-md-2 py-2"> <span class=float-sm-right > <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </span> </div> </div> </div> </footer> <script src="/libs/jquery/jquery.min.js"></script> <script src="/libs/bootstrap/bootstrap.min.js"></script> <script src="/libs/platform.js"></script>